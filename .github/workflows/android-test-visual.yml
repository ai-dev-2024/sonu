name: Android Build & Visual Test

on:
  workflow_dispatch:
  push:
    branches: [ mobile-v4, main ]
    paths:
      - 'apps/mobile/android/**'
      - '.github/workflows/android-test-visual.yml'
  pull_request:
    branches: [ mobile-v4, main ]
    paths:
      - 'apps/mobile/android/**'

jobs:
  build-and-visual-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      working-directory: apps/mobile/android
      run: |
        if [ ! -f gradlew ]; then
          echo "Gradle wrapper not found. Initializing..."
          gradle wrapper --gradle-version 8.3
        fi
        chmod +x gradlew || true
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          apps/mobile/android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('apps/mobile/android/**/*.gradle*', 'apps/mobile/android/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build Debug APK
      working-directory: apps/mobile/android
      run: |
        ./gradlew assembleDebug --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
    
    - name: Setup Android Emulator with Display
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        arch: x86_64
        profile: Nexus 6
        disable-animations: false
        script: |
          cd apps/mobile/android
          
          # Install APK
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          
          # Grant permissions
          adb shell pm grant com.sonu android.permission.RECORD_AUDIO
          adb shell pm grant com.sonu android.permission.READ_EXTERNAL_STORAGE
          adb shell pm grant com.sonu android.permission.WRITE_EXTERNAL_STORAGE
          
          # Launch app
          adb shell am start -n com.sonu/.MainActivity
          
          # Wait for app to load
          sleep 5
          
          # Take screenshot
          adb shell screencap -p /sdcard/screenshot.png
          adb pull /sdcard/screenshot.png screenshot-initial.png
          
          # Take multiple screenshots over time
          for i in {1..3}; do
            sleep 3
            adb shell screencap -p /sdcard/screenshot$i.png
            adb pull /sdcard/screenshot$i.png screenshot-$i.png
          done
          
          # Record screen (optional - creates video)
          # adb shell screenrecord --time-limit 30 /sdcard/demo.mp4 &
          # sleep 35
          # adb pull /sdcard/demo.mp4 demo.mp4
          
          # Run tests
          ./gradlew connectedAndroidTest --stacktrace --no-daemon || true
      continue-on-error: true
    
    - name: Upload Screenshots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: app-screenshots
        path: apps/mobile/android/screenshot*.png
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: debug-apk
        path: apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7

  firebase-test-lab-visual:
    runs-on: ubuntu-latest
    needs: build-and-visual-test
    if: github.event_name == 'workflow_dispatch' || contains(github.ref, 'refs/tags/')
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Download Debug APK
      uses: actions/download-artifact@v4
      with:
        name: debug-apk
        path: apps/mobile/android/app/build/outputs/apk/debug/
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
    
    - name: Run tests on Firebase Test Lab with Screenshots
      uses: reactivecircus/firebase-test-lab-action@v0
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
      with:
        service-account-json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        apk: apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
        device:
          - model: Pixel5
            version: 34
            locale: en
            orientation: portrait
        timeout: 20m
        results-bucket: ${{ secrets.FIREBASE_TEST_LAB_BUCKET }}
        results-dir: test-results/${{ github.sha }}
        # Enable video and screenshot capture
        environment-variables: |
          clearPackageData=true
      continue-on-error: true
    
    - name: Download Test Lab Results
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
      run: |
        # Download screenshots and videos from Firebase Test Lab
        gsutil -m cp -r gs://${{ secrets.FIREBASE_TEST_LAB_BUCKET }}/test-results/${{ github.sha }}/* ./test-lab-results/ || true
      continue-on-error: true
    
    - name: Upload Test Lab Screenshots/Videos
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firebase-test-lab-media
        path: test-lab-results/**/*.png
        retention-days: 7
        if-no-files-found: ignore

