name: Android Cloud Visual Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: true
        default: 'firebase'
        type: choice
        options:
          - firebase
          - browserstack
  push:
    branches: [ mobile-v4, main ]
    paths:
      - 'apps/mobile/android/**'
      - '.github/workflows/android-cloud-visual.yml'
  pull_request:
    branches: [ mobile-v4, main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      working-directory: apps/mobile/android
      run: |
        if [ ! -f gradlew ]; then
          gradle wrapper --gradle-version 8.3
        fi
        chmod +x gradlew || true
    
    - name: Build Debug APK
      working-directory: apps/mobile/android
      run: |
        ./gradlew assembleDebug --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-apk
        path: apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7

  firebase-test-lab:
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.test_type == 'firebase' || (github.event_name == 'push' && secrets.FIREBASE_SERVICE_ACCOUNT != '')
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: app-apk
        path: ./
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
    
    - name: Run tests on Firebase Test Lab
      uses: reactivecircus/firebase-test-lab-action@v0
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
      with:
        service-account-json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        apk: app-debug.apk
        device:
          - model: Pixel5
            version: 34
            locale: en
            orientation: portrait
          - model: Pixel6
            version: 33
            locale: en
            orientation: portrait
        timeout: 20m
        results-bucket: ${{ secrets.FIREBASE_TEST_LAB_BUCKET }}
        results-dir: test-results/${{ github.sha }}
        # Enable video and screenshot capture
        environment-variables: |
          clearPackageData=true
        # Capture screenshots and videos
        flaky-test-attempts: 1
      continue-on-error: true
    
    - name: Download Test Results
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
      run: |
        mkdir -p test-results
        gsutil -m cp -r gs://${{ secrets.FIREBASE_TEST_LAB_BUCKET }}/test-results/${{ github.sha }}/* ./test-results/ || echo "No results found"
      continue-on-error: true
    
    - name: Upload Test Lab Media
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firebase-screenshots-videos
        path: test-results/**/*.{png,jpg,mp4,webm}
        retention-days: 30
        if-no-files-found: ignore
    
    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: firebase-test-reports
        path: test-results/**/*.{xml,html,json}
        retention-days: 30
        if-no-files-found: ignore

  browserstack-test:
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.test_type == 'browserstack' || (github.event_name == 'push' && secrets.BROWSERSTACK_USERNAME != '')
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: app-apk
        path: ./
    
    - name: Upload APK to BrowserStack
      uses: browserstack/github-actions@master
      with:
        username: ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        command: upload
        file-path: app-debug.apk
        custom-id: sonu-app-${{ github.sha }}
    
    - name: Run App Live Test
      uses: browserstack/github-actions@master
      if: ${{ secrets.BROWSERSTACK_USERNAME != '' }}
      with:
        username: ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        command: app-live
        app-id: sonu-app-${{ github.sha }}
        device: "Google Pixel 5"
        os-version: "12.0"
        # Enable screenshot capture
        screenshot: true
      continue-on-error: true
    
    - name: Download BrowserStack Screenshots
      if: ${{ secrets.BROWSERSTACK_USERNAME != '' }}
      run: |
        mkdir -p browserstack-results
        # BrowserStack API to download screenshots
        curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
          "https://api.browserstack.com/app-automate/sessions.json" > browserstack-results/sessions.json || true
      continue-on-error: true
    
    - name: Upload BrowserStack Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: browserstack-results
        path: browserstack-results/**
        retention-days: 7
        if-no-files-found: ignore

