name: Android Build & Test

on:
  push:
    branches: [ mobile-v4, main ]
    paths:
      - 'apps/mobile/android/**'
      - '.github/workflows/android-test.yml'
  pull_request:
    branches: [ mobile-v4, main ]
    paths:
      - 'apps/mobile/android/**'
      - '.github/workflows/android-test.yml'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Grant execute permission for gradlew
      working-directory: apps/mobile/android
      run: |
        if [ ! -f gradlew ]; then
          echo "Gradle wrapper not found. Initializing..."
          gradle wrapper --gradle-version 8.3
        fi
        chmod +x gradlew || true
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          apps/mobile/android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('apps/mobile/android/**/*.gradle*', 'apps/mobile/android/gradle/wrapper/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Cache Android dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/build-cache
          ${{ env.ANDROID_HOME }}/.android
        key: ${{ runner.os }}-android-${{ hashFiles('apps/mobile/android/**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-android-
    
    - name: Build Debug APK
      working-directory: apps/mobile/android
      run: |
        ./gradlew assembleDebug --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
    
    - name: Build Release APK (unsigned)
      working-directory: apps/mobile/android
      run: |
        ./gradlew assembleRelease --stacktrace --no-daemon
      env:
        ANDROID_HOME: ${{ env.ANDROID_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      continue-on-error: true
    
    - name: Run Unit Tests
      working-directory: apps/mobile/android
      run: |
        ./gradlew test --stacktrace --no-daemon
      continue-on-error: true
    
    - name: Setup Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        arch: x86_64
        profile: Nexus 6
        script: |
          cd apps/mobile/android
          ./gradlew connectedAndroidTest --stacktrace --no-daemon
      continue-on-error: true
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: debug-apk
        path: apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7
    
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: release-apk
        path: apps/mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          apps/mobile/android/app/build/test-results/**/*.xml
          apps/mobile/android/app/build/outputs/androidTest-results/**/*.xml
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          apps/mobile/android/app/build/**/*.log
        retention-days: 3
        if-no-files-found: ignore

  firebase-test-lab:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'workflow_dispatch' || contains(github.ref, 'refs/tags/')
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Download Debug APK
      uses: actions/download-artifact@v4
      with:
        name: debug-apk
        path: apps/mobile/android/app/build/outputs/apk/debug/
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
    
    - name: Run tests on Firebase Test Lab
      uses: reactivecircus/firebase-test-lab-action@v0
      if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
      with:
        service-account-json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        apk: apps/mobile/android/app/build/outputs/apk/debug/app-debug.apk
        device:
          - model: Pixel5
            version: 34
            locale: en
            orientation: portrait
        timeout: 20m
        results-bucket: ${{ secrets.FIREBASE_TEST_LAB_BUCKET }}
        results-dir: test-results/${{ github.sha }}
      continue-on-error: true

